<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reset Password</title>
  <!-- Import Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <script src="js/dungchung.js"></script>
  <script src="js/classes.js"></script>
  <style>
    .close {
      /* nút tắt form */
      position: fixed;
      top: 5px;
      right: 5px;
      font-size: 3rem;
      width: 1em;
      height: 1em;
      line-height: 36px;
      text-align: center;
      color: #000000;
      cursor: pointer;
      transition: .2s ease;
      font-weight: 900;
    }

    .close:hover {
      color: #000000;
      background-color: #f33;
      border-radius: 50%;
    }
  </style>
</head>

<body>
  <span class="close" onclick="window.location.href='index.html'">&times;</span>

  <div class="container">
    <div class="row justify-content-center mt-5">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h4 class="text-center">Đặt lại mật khẩu</h4>
          </div>
          <div class="card-body">
            <form>
              <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" name="email" id="email" class="form-control" required />
              </div>
              <button type="button" name="submit" class="btn btn-primary btn-block" onclick="validateEmail()">
                Reset Password
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Import Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <!-- Import SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
  <script>

    var listUser = getListUser();
    console.log(listUser)
    function validateEmail() {
      const email = document.getElementById("email").value;
      var emailExists = false;

      for (var u of listUser) {
        if (u.email === email) {
          emailExists = true;
          const newPassword = generateRandomPassword(8);
          var temp = copyObject(u);
          u.pass = newPassword;
          // cập nhật danh sách sản phẩm trong localstorage
          updateListUser(temp, u);
          resetPassword(email, newPassword);
          break;
        }
      }

      if (!emailExists) {
        // If email does not exist, display an error message
        Swal.fire({
          icon: "error",
          title: "Email không tồn tại",
          text: "Vui lòng nhập một địa chỉ email tồn tại.",
          confirmButtonText: "OK",
        });
      }
    }

    function resetPassword(email, newPassword) {

      sendEmailNotification(email, newPassword);

      // Hiển thị thông báo cho người dùng sử dụng SweetAlert2
      Swal.fire({
        icon: "success",
        title: "Mật khẩu mới đã được gửi",
        text: `Mật khẩu mới đã được gửi đến ${email}. Vui lòng kiểm tra email của bạn.`,
        confirmButtonText: "OK",
      }).then((result) => {
        if (result.isConfirmed) {
          // Chuyển hướng trang web về index.html hoặc trang khác
          window.location.href = "index.html";
          sendEmailNotification(email, newPassword);
        }
      });
    }

    function sendEmailNotification(email, newPassword) {
      emailjs.init("T0kVSb9470O5Pa9IH");
      var templateParams = {
        to_email: email, // Địa chỉ email người nhận
        to_name: email,
        Text: newPassword, //
      };

      // Sử dụng public key thay thế cho User ID
      emailjs
        .send("service_947rffi", "template_f4prki8", templateParams) // Thay your_service_id và your_template_id bằng thông tin tương ứng của bạn
        .then(
          function (response) {
            console.log("Email đã được gửi thành công: ", response);
          },
          function (error) {
            console.log("Lỗi khi gửi email: ", error);
          }
        );
    }

    // Hàm tạo mật khẩu ngẫu nhiên
    function generateRandomPassword(length) {
      const charset =
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let password = "";
      for (let i = 0; i < length; i++) {
        const randomIndex = Math.floor(Math.random() * charset.length);
        password += charset.charAt(randomIndex);
      }
      return password;
    }

    // Hàm kiểm tra địa chỉ email hợp lệ (đơn giản)
    function isValidEmail(email) {
      const emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
      return emailPattern.test(email);
    }
  </script>
</body>

</html>